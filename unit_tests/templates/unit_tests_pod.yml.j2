apiVersion: v1
kind: Pod
metadata:
  name: tower-unit-tests-{{ lookup('env', 'BUILD_ID')|default('debug') }}
  labels:
    name: tower-unit-tests-{{ lookup('env', 'BUILD_ID')|default('debug') }}
spec:
  containers:
    - name: tower-unit-tests-{{ lookup('env', 'BUILD_ID')|default('debug') }}
      image: gcr.io/ansible-tower-engineering/tools_tower_unit:{{ lookup('env', 'BAKE_BUILD_ID')|default('latest') }}
      imagePullPolicy: Always
      env:
        - name: SKIP_SLOW_TESTS
          value: "{{ lookup('env', 'SKIP_SLOW_TESTS')|default(false) }}"
#      command:
#        - /ansible-tower/tools/docker-compose/start_unit.sh
#        - /ansible-tower/
#        - py.test
#        - --create-db
#        - --cov=awx
#        - --cov-report=xml
#        - --junitxml=./reports/junit.xml
#        - awx/main/tests/unit/test_credentials.py
      volumeMounts:
        - name: artifacts
          mountPath: /ansible-tower/reports
      SecurityContext:
        privileged: true

    - name: tower-unit-tests-artifacts-{{ lookup('env', 'BUILD_ID')|default('debug') }}
      image: ubuntu
      imagePullPolicy: Always
      command: 
        - sleep
        - "43200"   # 12 hours
      volumeMounts:
        - name: artifacts
          mountPath: /artifacts

  volumes:
    - name: artifacts
      emptyDir: {}
