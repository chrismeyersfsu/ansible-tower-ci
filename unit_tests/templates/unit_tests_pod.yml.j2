apiVersion: v1
kind: Pod
metadata:
  name: tower-unit-tests-{{ lookup('env', 'BUILD_ID') }}
  labels:
    name: tower-unit-tests-{{ lookup('env', 'BUILD_ID') }}
spec:
  containers:
    - name: tower-unit-tests-{{ lookup('env', 'BUILD_ID') }}
      image: gcr.io/ansible-tower-engineering/tools_tower_unit:{{ lookup('env', 'BAKE_BUILD_ID') }}
      imagePullPolicy: Always
      env:
        - name: SKIP_SLOW_TESTS
          value: "{{ lookup('env', 'SKIP_SLOW_TESTS') }}"
      volumeMounts:
        - name: tower-unit-tests-volume
          mountPath: /ansible-tower/reports/

    - name: tower-unit-tests-slave-{{ lookup('env', 'BUILD_ID') }}
      image: gcr.io/ansible-tower-engineering/jenkins-jnlp-docker-ansible:latest
      imagePullPolicy: Always
      command:
        - "java"
        - "-jar"
        - "/usr/share/jenkins/slave.jar"
        - "-jnlpUrl" 
        - "{{ lookup('env', 'JENKINS_URL') }}/computer/test-slave/slave-agent.jnlp"
        - "-jnlpCredentials"
        - "{{ lookup('env', 'JENKINS_LOGIN_USERNAME') }}:{{ lookup('env', 'JENKINS_LOGIN_PASSWORD') }}"
      volumeMounts:
        - name: tower-unit-tests-volume
          mountPath: /reports

  volumes:
    - name: tower-unit-tests-volume
      emptyDir: {}
            
